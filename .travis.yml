sudo: required
dist: trusty
language: cpp
python:
  - 2.7
branches:
  only:
    - master
    - develop
compiler:
  - gcc
  - clang
env:
  - INSTALL="libhdf5-dev liblog4cxx10-dev" BOOST= FLAGS= TESTS=RMF TEST_SETUP=
  - INSTALL="" BOOST= FLAGS= TESTS=RMF TEST_SETUP=
git:
  submodules: false

matrix:
  exclude:
    # I don't understand this failure, and it is only in deprecated code
    - compiler: gcc
      env: INSTALL="libhdf5-dev liblog4cxx10-dev" BOOST= FLAGS= TESTS=RMF TEST_SETUP=
  include:
    # can't get it to work with the python module
    - compiler: clang
      env: INSTALL= BOOST= FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer" TESTS=cpp TEST_SETUP=

before_install:
 - sudo apt-get update -qq
 - sudo apt-get install -qq libboost$BOOST-all-dev swig libc-dbg $INSTALL

script:
 - mkdir build
 - cd build
 - ../tools/coverage/setup.py
 - find /opt/python/2.7.10
 - find ~/virtualenv
 - PYTHONPATH=`pwd`/coverage cmake .. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="$FLAGS --coverage" -DCMAKE_EXE_LINKER_FLAGS="$FLAGS --coverage" -DCMAKE_MODULE_LINKER_FLAGS="$FLAGS --coverage" -DCMAKE_SHARED_LINKER_FLAGS="$FLAGS --coverage" -DIMP_TEST_SETUP=$TEST_SETUP
 - make -j 2
 - export LD_PRELOAD=/lib/x86_64-linux-gnu/libSegFault.so
 - ctest -j 2 --output-on-failure -L $TESTS
 - (cd coverage && coverage combine && mv .coverage ..)
 - bash <(curl -s https://codecov.io/bash)

# sanitize :-) -fsanitize=address -fno-omit-frame-pointer
# -fsanitize=undefined
#1.48 seems to exist
# [ci skip]
